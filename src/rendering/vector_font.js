// Vector Font for Oscilloscope Text Display
// AIDEV-NOTE: Each character is defined as line segments in a 1x1 unit box
// Coordinates go from (0,0) bottom-left to (1,1) top-right

/**
 * Vector font definition
 * Each character maps to an array of line segments
 * Each segment is [x1, y1, x2, y2] normalized to 0-1 range
 */
const VECTOR_FONT = {
    'A': [
        [0.0, 0.0, 0.5, 1.0],  // Left diagonal
        [0.5, 1.0, 1.0, 0.0],  // Right diagonal
        [0.2, 0.4, 0.8, 0.4],  // Crossbar
    ],
    'B': [
        [0.0, 0.0, 0.0, 1.0],  // Vertical
        [0.0, 1.0, 0.7, 1.0],  // Top horizontal
        [0.7, 1.0, 0.8, 0.8],  // Top curve
        [0.8, 0.8, 0.8, 0.6],
        [0.8, 0.6, 0.7, 0.5],
        [0.7, 0.5, 0.0, 0.5],  // Middle
        [0.7, 0.5, 0.9, 0.3],  // Bottom curve
        [0.9, 0.3, 0.9, 0.1],
        [0.9, 0.1, 0.7, 0.0],
        [0.7, 0.0, 0.0, 0.0],  // Bottom horizontal
    ],
    'C': [
        [1.0, 0.8, 0.7, 1.0],
        [0.7, 1.0, 0.3, 1.0],
        [0.3, 1.0, 0.0, 0.7],
        [0.0, 0.7, 0.0, 0.3],
        [0.0, 0.3, 0.3, 0.0],
        [0.3, 0.0, 0.7, 0.0],
        [0.7, 0.0, 1.0, 0.2],
    ],
    'D': [
        [0.0, 0.0, 0.0, 1.0],
        [0.0, 1.0, 0.6, 1.0],
        [0.6, 1.0, 0.9, 0.7],
        [0.9, 0.7, 0.9, 0.3],
        [0.9, 0.3, 0.6, 0.0],
        [0.6, 0.0, 0.0, 0.0],
    ],
    'E': [
        [0.0, 0.0, 0.0, 1.0],
        [0.0, 1.0, 0.9, 1.0],
        [0.0, 0.5, 0.7, 0.5],
        [0.0, 0.0, 0.9, 0.0],
    ],
    'F': [
        [0.0, 0.0, 0.0, 1.0],
        [0.0, 1.0, 0.9, 1.0],
        [0.0, 0.5, 0.7, 0.5],
    ],
    'G': [
        [1.0, 0.8, 0.7, 1.0],
        [0.7, 1.0, 0.3, 1.0],
        [0.3, 1.0, 0.0, 0.7],
        [0.0, 0.7, 0.0, 0.3],
        [0.0, 0.3, 0.3, 0.0],
        [0.3, 0.0, 0.7, 0.0],
        [0.7, 0.0, 1.0, 0.3],
        [1.0, 0.3, 1.0, 0.5],
        [1.0, 0.5, 0.5, 0.5],
    ],
    'H': [
        [0.0, 0.0, 0.0, 1.0],
        [1.0, 0.0, 1.0, 1.0],
        [0.0, 0.5, 1.0, 0.5],
    ],
    'I': [
        [0.3, 0.0, 0.7, 0.0],
        [0.5, 0.0, 0.5, 1.0],
        [0.3, 1.0, 0.7, 1.0],
    ],
    'J': [
        [0.3, 1.0, 0.9, 1.0],
        [0.7, 1.0, 0.7, 0.2],
        [0.7, 0.2, 0.5, 0.0],
        [0.5, 0.0, 0.2, 0.0],
        [0.2, 0.0, 0.0, 0.2],
    ],
    'K': [
        [0.0, 0.0, 0.0, 1.0],
        [0.0, 0.4, 1.0, 1.0],
        [0.3, 0.55, 1.0, 0.0],
    ],
    'L': [
        [0.0, 1.0, 0.0, 0.0],
        [0.0, 0.0, 0.9, 0.0],
    ],
    'M': [
        [0.0, 0.0, 0.0, 1.0],
        [0.0, 1.0, 0.5, 0.4],
        [0.5, 0.4, 1.0, 1.0],
        [1.0, 1.0, 1.0, 0.0],
    ],
    'N': [
        [0.0, 0.0, 0.0, 1.0],
        [0.0, 1.0, 1.0, 0.0],
        [1.0, 0.0, 1.0, 1.0],
    ],
    'O': [
        [0.3, 0.0, 0.7, 0.0],
        [0.7, 0.0, 1.0, 0.3],
        [1.0, 0.3, 1.0, 0.7],
        [1.0, 0.7, 0.7, 1.0],
        [0.7, 1.0, 0.3, 1.0],
        [0.3, 1.0, 0.0, 0.7],
        [0.0, 0.7, 0.0, 0.3],
        [0.0, 0.3, 0.3, 0.0],
    ],
    'P': [
        [0.0, 0.0, 0.0, 1.0],
        [0.0, 1.0, 0.7, 1.0],
        [0.7, 1.0, 0.9, 0.8],
        [0.9, 0.8, 0.9, 0.6],
        [0.9, 0.6, 0.7, 0.45],
        [0.7, 0.45, 0.0, 0.45],
    ],
    'Q': [
        [0.3, 0.0, 0.7, 0.0],
        [0.7, 0.0, 1.0, 0.3],
        [1.0, 0.3, 1.0, 0.7],
        [1.0, 0.7, 0.7, 1.0],
        [0.7, 1.0, 0.3, 1.0],
        [0.3, 1.0, 0.0, 0.7],
        [0.0, 0.7, 0.0, 0.3],
        [0.0, 0.3, 0.3, 0.0],
        [0.6, 0.25, 1.0, -0.1],  // Tail
    ],
    'R': [
        [0.0, 0.0, 0.0, 1.0],
        [0.0, 1.0, 0.7, 1.0],
        [0.7, 1.0, 0.9, 0.8],
        [0.9, 0.8, 0.9, 0.6],
        [0.9, 0.6, 0.7, 0.45],
        [0.7, 0.45, 0.0, 0.45],
        [0.5, 0.45, 1.0, 0.0],  // Leg
    ],
    'S': [
        [1.0, 0.85, 0.7, 1.0],
        [0.7, 1.0, 0.3, 1.0],
        [0.3, 1.0, 0.0, 0.8],
        [0.0, 0.8, 0.0, 0.6],
        [0.0, 0.6, 0.3, 0.5],
        [0.3, 0.5, 0.7, 0.5],
        [0.7, 0.5, 1.0, 0.4],
        [1.0, 0.4, 1.0, 0.2],
        [1.0, 0.2, 0.7, 0.0],
        [0.7, 0.0, 0.3, 0.0],
        [0.3, 0.0, 0.0, 0.15],
    ],
    'T': [
        [0.0, 1.0, 1.0, 1.0],
        [0.5, 1.0, 0.5, 0.0],
    ],
    'U': [
        [0.0, 1.0, 0.0, 0.3],
        [0.0, 0.3, 0.3, 0.0],
        [0.3, 0.0, 0.7, 0.0],
        [0.7, 0.0, 1.0, 0.3],
        [1.0, 0.3, 1.0, 1.0],
    ],
    'V': [
        [0.0, 1.0, 0.5, 0.0],
        [0.5, 0.0, 1.0, 1.0],
    ],
    'W': [
        [0.0, 1.0, 0.2, 0.0],
        [0.2, 0.0, 0.5, 0.5],
        [0.5, 0.5, 0.8, 0.0],
        [0.8, 0.0, 1.0, 1.0],
    ],
    'X': [
        [0.0, 0.0, 1.0, 1.0],
        [0.0, 1.0, 1.0, 0.0],
    ],
    'Y': [
        [0.0, 1.0, 0.5, 0.5],
        [1.0, 1.0, 0.5, 0.5],
        [0.5, 0.5, 0.5, 0.0],
    ],
    'Z': [
        [0.0, 1.0, 1.0, 1.0],
        [1.0, 1.0, 0.0, 0.0],
        [0.0, 0.0, 1.0, 0.0],
    ],
    
    // Numbers
    '0': [
        [0.3, 0.0, 0.7, 0.0],
        [0.7, 0.0, 1.0, 0.3],
        [1.0, 0.3, 1.0, 0.7],
        [1.0, 0.7, 0.7, 1.0],
        [0.7, 1.0, 0.3, 1.0],
        [0.3, 1.0, 0.0, 0.7],
        [0.0, 0.7, 0.0, 0.3],
        [0.0, 0.3, 0.3, 0.0],
        [0.2, 0.2, 0.8, 0.8],  // Diagonal slash
    ],
    '1': [
        [0.3, 0.8, 0.5, 1.0],
        [0.5, 1.0, 0.5, 0.0],
        [0.2, 0.0, 0.8, 0.0],
    ],
    '2': [
        [0.0, 0.8, 0.3, 1.0],
        [0.3, 1.0, 0.7, 1.0],
        [0.7, 1.0, 1.0, 0.8],
        [1.0, 0.8, 1.0, 0.6],
        [1.0, 0.6, 0.0, 0.0],
        [0.0, 0.0, 1.0, 0.0],
    ],
    '3': [
        [0.0, 0.85, 0.3, 1.0],
        [0.3, 1.0, 0.7, 1.0],
        [0.7, 1.0, 1.0, 0.75],
        [1.0, 0.75, 0.7, 0.5],
        [0.7, 0.5, 0.4, 0.5],
        [0.7, 0.5, 1.0, 0.25],
        [1.0, 0.25, 0.7, 0.0],
        [0.7, 0.0, 0.3, 0.0],
        [0.3, 0.0, 0.0, 0.15],
    ],
    '4': [
        [0.7, 0.0, 0.7, 1.0],
        [0.7, 1.0, 0.0, 0.3],
        [0.0, 0.3, 1.0, 0.3],
    ],
    '5': [
        [1.0, 1.0, 0.0, 1.0],
        [0.0, 1.0, 0.0, 0.55],
        [0.0, 0.55, 0.7, 0.55],
        [0.7, 0.55, 1.0, 0.4],
        [1.0, 0.4, 1.0, 0.15],
        [1.0, 0.15, 0.7, 0.0],
        [0.7, 0.0, 0.2, 0.0],
        [0.2, 0.0, 0.0, 0.1],
    ],
    '6': [
        [0.8, 1.0, 0.3, 1.0],
        [0.3, 1.0, 0.0, 0.7],
        [0.0, 0.7, 0.0, 0.2],
        [0.0, 0.2, 0.3, 0.0],
        [0.3, 0.0, 0.7, 0.0],
        [0.7, 0.0, 1.0, 0.2],
        [1.0, 0.2, 1.0, 0.4],
        [1.0, 0.4, 0.7, 0.55],
        [0.7, 0.55, 0.0, 0.55],
    ],
    '7': [
        [0.0, 1.0, 1.0, 1.0],
        [1.0, 1.0, 0.3, 0.0],
    ],
    '8': [
        [0.3, 0.5, 0.0, 0.7],
        [0.0, 0.7, 0.0, 0.85],
        [0.0, 0.85, 0.3, 1.0],
        [0.3, 1.0, 0.7, 1.0],
        [0.7, 1.0, 1.0, 0.85],
        [1.0, 0.85, 1.0, 0.7],
        [1.0, 0.7, 0.7, 0.5],
        [0.7, 0.5, 0.3, 0.5],
        [0.7, 0.5, 1.0, 0.3],
        [1.0, 0.3, 1.0, 0.15],
        [1.0, 0.15, 0.7, 0.0],
        [0.7, 0.0, 0.3, 0.0],
        [0.3, 0.0, 0.0, 0.15],
        [0.0, 0.15, 0.0, 0.3],
        [0.0, 0.3, 0.3, 0.5],
    ],
    '9': [
        [0.2, 0.0, 0.7, 0.0],
        [0.7, 0.0, 1.0, 0.3],
        [1.0, 0.3, 1.0, 0.8],
        [1.0, 0.8, 0.7, 1.0],
        [0.7, 1.0, 0.3, 1.0],
        [0.3, 1.0, 0.0, 0.8],
        [0.0, 0.8, 0.0, 0.6],
        [0.0, 0.6, 0.3, 0.45],
        [0.3, 0.45, 1.0, 0.45],
    ],
    
    // Punctuation
    '.': [
        [0.4, 0.0, 0.6, 0.0],
        [0.6, 0.0, 0.6, 0.15],
        [0.6, 0.15, 0.4, 0.15],
        [0.4, 0.15, 0.4, 0.0],
    ],
    ',': [
        [0.5, 0.15, 0.5, 0.0],
        [0.5, 0.0, 0.3, -0.15],
    ],
    ':': [
        [0.4, 0.25, 0.6, 0.25],
        [0.6, 0.25, 0.6, 0.35],
        [0.6, 0.35, 0.4, 0.35],
        [0.4, 0.35, 0.4, 0.25],
        [0.4, 0.65, 0.6, 0.65],
        [0.6, 0.65, 0.6, 0.75],
        [0.6, 0.75, 0.4, 0.75],
        [0.4, 0.75, 0.4, 0.65],
    ],
    '!': [
        [0.5, 1.0, 0.5, 0.3],
        [0.4, 0.0, 0.6, 0.0],
        [0.6, 0.0, 0.6, 0.15],
        [0.6, 0.15, 0.4, 0.15],
        [0.4, 0.15, 0.4, 0.0],
    ],
    '?': [
        [0.0, 0.8, 0.3, 1.0],
        [0.3, 1.0, 0.7, 1.0],
        [0.7, 1.0, 1.0, 0.8],
        [1.0, 0.8, 1.0, 0.6],
        [1.0, 0.6, 0.5, 0.4],
        [0.5, 0.4, 0.5, 0.25],
        [0.4, 0.0, 0.6, 0.0],
        [0.6, 0.0, 0.6, 0.12],
        [0.6, 0.12, 0.4, 0.12],
        [0.4, 0.12, 0.4, 0.0],
    ],
    '-': [
        [0.2, 0.5, 0.8, 0.5],
    ],
    '_': [
        [0.0, 0.0, 1.0, 0.0],
    ],
    '/': [
        [0.0, 0.0, 1.0, 1.0],
    ],
    '(': [
        [0.7, 1.0, 0.3, 0.7],
        [0.3, 0.7, 0.3, 0.3],
        [0.3, 0.3, 0.7, 0.0],
    ],
    ')': [
        [0.3, 1.0, 0.7, 0.7],
        [0.7, 0.7, 0.7, 0.3],
        [0.7, 0.3, 0.3, 0.0],
    ],
    '[': [
        [0.7, 1.0, 0.3, 1.0],
        [0.3, 1.0, 0.3, 0.0],
        [0.3, 0.0, 0.7, 0.0],
    ],
    ']': [
        [0.3, 1.0, 0.7, 1.0],
        [0.7, 1.0, 0.7, 0.0],
        [0.7, 0.0, 0.3, 0.0],
    ],
    '%': [
        [0.0, 0.0, 1.0, 1.0],
        [0.1, 0.8, 0.3, 0.8],
        [0.3, 0.8, 0.3, 0.95],
        [0.3, 0.95, 0.1, 0.95],
        [0.1, 0.95, 0.1, 0.8],
        [0.7, 0.05, 0.9, 0.05],
        [0.9, 0.05, 0.9, 0.2],
        [0.9, 0.2, 0.7, 0.2],
        [0.7, 0.2, 0.7, 0.05],
    ],
    '+': [
        [0.5, 0.2, 0.5, 0.8],
        [0.2, 0.5, 0.8, 0.5],
    ],
    '=': [
        [0.1, 0.6, 0.9, 0.6],
        [0.1, 0.4, 0.9, 0.4],
    ],
    '<': [
        [0.8, 0.8, 0.2, 0.5],
        [0.2, 0.5, 0.8, 0.2],
    ],
    '>': [
        [0.2, 0.8, 0.8, 0.5],
        [0.8, 0.5, 0.2, 0.2],
    ],
    '*': [
        [0.5, 0.2, 0.5, 0.8],      // Vertical line (taller)
        [0.15, 0.35, 0.85, 0.65],  // Diagonal (wider)
        [0.15, 0.65, 0.85, 0.35],  // Diagonal (wider)
    ],
    '"': [
        [0.3, 1.0, 0.3, 0.75],
        [0.7, 1.0, 0.7, 0.75],
    ],
    "'": [
        [0.5, 1.0, 0.5, 0.75],
    ],
    
    // Space is empty (no lines)
    ' ': [],
};

/**
 * Get line segments for a character
 * @param {string} char - Single character
 * @returns {Array} Array of [x1, y1, x2, y2] line segments
 */
function getCharacterLines(char) {
    const upperChar = char.toUpperCase();
    if (VECTOR_FONT.hasOwnProperty(upperChar)) {
        return VECTOR_FONT[upperChar];
    }
    // Unknown character - render as a box with X
    return [
        [0.0, 0.0, 1.0, 0.0],
        [1.0, 0.0, 1.0, 1.0],
        [1.0, 1.0, 0.0, 1.0],
        [0.0, 1.0, 0.0, 0.0],
        [0.0, 0.0, 1.0, 1.0],
        [0.0, 1.0, 1.0, 0.0],
    ];
}

/**
 * Generate line segments for a string of text with word-boundary wrapping
 * @param {string} text - The text to render
 * @param {number} startX - Starting X position in UV coords (0-1)
 * @param {number} startY - Starting Y position in UV coords (0-1)
 * @param {number} charWidth - Width of each character
 * @param {number} charHeight - Height of each character
 * @param {number} [maxX] - Right margin for wrapping (default: 0.95)
 * @returns {Float32Array} Flat array of vec4s (x1, y1, x2, y2) for shader
 */
function generateTextLines(text, startX, startY, charWidth, charHeight, maxX = 0.95) {
    const lines = [];
    let cursorX = startX;
    let cursorY = startY;
    const charAdvance = charWidth * 1.2;
    const lineHeight = charHeight * 1.4;
    const lineWidth = maxX - startX;
    
    // Split text into lines (by explicit newlines)
    const textLines = text.split('\n');
    
    for (let lineIdx = 0; lineIdx < textLines.length; lineIdx++) {
        const textLine = textLines[lineIdx];
        
        // Reset X for each explicit line
        if (lineIdx > 0) {
            cursorX = startX;
            cursorY -= lineHeight;
        }
        
        // Split line into words
        const words = textLine.split(' ');
        
        for (let wordIdx = 0; wordIdx < words.length; wordIdx++) {
            const word = words[wordIdx];
            const wordWidth = word.length * charAdvance;
            
            // Check if word fits on current line
            // (but always allow at least one word per line)
            if (cursorX > startX && cursorX + wordWidth > maxX) {
                // Wrap to next line
                cursorX = startX;
                cursorY -= lineHeight;
            }
            
            // Render each character in word
            for (let i = 0; i < word.length; i++) {
                const char = word[i];
                const charLines = getCharacterLines(char);
                
                // Transform character lines to screen position
                for (const segment of charLines) {
                    lines.push(
                        cursorX + segment[0] * charWidth,    // x1
                        cursorY + segment[1] * charHeight,   // y1
                        cursorX + segment[2] * charWidth,    // x2
                        cursorY + segment[3] * charHeight    // y2
                    );
                }
                
                cursorX += charAdvance;
            }
            
            // Add space after word (unless it's the last word)
            if (wordIdx < words.length - 1) {
                // Check if space would push us past margin
                if (cursorX + charAdvance <= maxX) {
                    cursorX += charAdvance; // Space width
                }
            }
        }
    }
    
    return new Float32Array(lines);
}

